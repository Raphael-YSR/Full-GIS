document.addEventListener('DOMContentLoaded', () => {
    // DELETE PROJECT DATA //
    const projectId = getProjectIdFromUrl();
    const projectDetailsDiv = document.getElementById('projectDetails');
    const deleteBtn = document.getElementById('deleteBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    // Create popup container and add it to the body
    const popupContainer = document.createElement('div');
    popupContainer.className = 'fixed inset-0 flex items-center justify-center z-50 hidden';
    popupContainer.id = 'customPopup';
    
    popupContainer.innerHTML = `
        <div class="absolute inset-0 bg-black bg-opacity-30"></div>
        <div class="bg-black rounded-lg shadow-lg p-6 max-w-md w-full mx-4 relative z-10 font-marlinsoftmedium">
            <div class="flex items-center">
                <div id="popupIcon" class="flex items-center justify-center mr-4 flex-shrink-0 rounded-full p-2">
                    <svg id="successIcon" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <svg id="errorIcon" class="h-5 w-5 text-red-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div>
                    <p class="font-bold text-white" id="popupTitle">Success</p>
                    <p class="text-white" id="popupMessage"></p>
                </div>
            </div>
            <button id="closePopup" class="mt-4 w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                OK
            </button>
        </div>
    `;
    
    document.body.appendChild(popupContainer);
    
    // Set up event listener for the close button
    document.getElementById('closePopup').addEventListener('click', () => {
        popupContainer.classList.add('hidden');
        
        // Redirect to search page if deletion was successful
        if (document.getElementById('popupTitle').textContent === 'Success') {
            window.location.href = '/search';
        }
    });
    
    // Click outside to close
    popupContainer.addEventListener('click', (e) => {
        if (e.target === popupContainer || e.target === popupContainer.firstElementChild) {
            popupContainer.classList.add('hidden');
            
            // Redirect to search page if deletion was successful
            if (document.getElementById('popupTitle').textContent === 'Success') {
                window.location.href = '/search';
            }
        }
    });

    // Function to show the custom popup
    function showPopup(message, isError = false) {
        const title = isError ? 'Error' : 'Success';
        document.getElementById('popupTitle').textContent = title;
        document.getElementById('popupMessage').textContent = message;
        
        // Show the appropriate icon
        document.getElementById('successIcon').classList.toggle('hidden', isError);
        document.getElementById('errorIcon').classList.toggle('hidden', !isError);
        document.getElementById('popupIcon').className = 'flex items-center justify-center mr-4 flex-shrink-0 rounded-full p-2 ' + 
            (isError ? 'bg-red-100' : 'bg-green-100');
        
        popupContainer.classList.remove('hidden');
        
        // Auto-close after 5 seconds only for success messages
        if (!isError) {
            setTimeout(() => {
                popupContainer.classList.add('hidden');
                window.location.href = '/search';
            }, 5000);
        }
    }

    if (projectId) {
        fetchProjectDetails(projectId);
    } else {
        showPopup('Project ID not found in URL.', true);
    }

    // Function to extract project ID from URL
    function getProjectIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    async function fetchProjectDetails(projectId) {
        console.log('Fetching project details for ID:', projectId); 
        try {
            const response = await fetch(`/api/project/${projectId}`);
            console.log('API response:', response); 
            if (response.ok) {
                const project = await response.json();
                console.log('Project data:', project); 
                
                // Fetch related data (county name and project type name)
                const countyResponse = await fetch(`/api/counties`);
                const typeResponse = await fetch(`/api/types`);
                const statusResponse = await fetch(`/api/statuses`);
                
                if (countyResponse.ok && typeResponse.ok && statusResponse.ok) {
                    const counties = await countyResponse.json();
                    const types = await typeResponse.json();
                    const statuses = await statusResponse.json();
                    
                    // Find the matching county, type, and status
                    const county = counties.find(c => c.id == project.county_id);
                    const projectType = types.find(t => t.id == project.project_type);
                    const status = statuses.find(s => s.id == project.project_status);
                    
                    // Add the names to the project data
                    project.county_name = county ? county.county_name : 'Unknown';
                    project.type_name = projectType ? projectType.type : 'Unknown';
                    project.status_name = status ? status.status : 'Unknown';
                    
                    displayProjectDetails(project);
                } else {
                    // Still display with IDs if we can't get names
                    displayProjectDetails(project);
                }
            } else {
                console.log('API response not ok', response);
                showPopup('Error fetching project details.', true);
            }
        } catch (error) {
            console.error('Error:', error);
            showPopup('An error occurred.', true);
        }
    }

    function displayProjectDetails(project) {
        // Format the project details with county name and project type name
        projectDetailsDiv.innerHTML = `
            <h2 class="text-xl font-bold font-marlin mb-2">${project.project_name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</h2>
            <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                <div>
                    <div class="text-gray-400 font-marlinsoftmedium">County:</div>
                    <div class="font-marlinsoftmedium">${project.county_name || 'ID: ' + project.county_id}</div>
                </div>
                <div>
                    <div class="text-gray-400 font-marlinsoftmedium">Project Type:</div>
                    <div class="font-marlinsoftmedium">${project.type_name || 'ID: ' + project.project_type}</div>
                </div>
                <div>
                    <div class="text-gray-400 font-marlinsoftmedium">People Served:</div>
                    <div class="font-marlinsoftmedium">${project.people_served || 'Not specified'}</div>
                </div>
                <div>
                    <div class="text-gray-400 font-marlinsoftmedium">Progress:</div>
                    <div class="font-marlinsoftmedium">${project.progress || '0'}%</div>
                </div>
                <div>
                    <div class="text-gray-400 font-marlinsoftmedium">Status:</div>
                    <div class="font-marlinsoftmedium">${project.status_name || 'ID: ' + project.project_status}</div>
                </div>
                <div>
                    <div class="text-gray-400 font-marlinsoftmedium">Coordinates:</div>
                    <div class="font-marlinsoftmedium">${project.latitude || 'N/A'}, ${project.longitude || 'N/A'}</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="text-gray-400 font-marlinsoftmedium">Description:</div>
                <div class="font-marlinsoftmedium text-sm mt-1">${project.description || 'No description available.'}</div>
            </div>
        `;
    }

    // Set up event listeners for buttons
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`/api/project/${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showPopup(result.message);
                } else {
                    const errorData = await response.json();
                    showPopup(errorData.error || 'Error deleting project.', true);
                }
            } catch (error) {
                console.error('Error:', error);
                showPopup('An error occurred during deletion.', true);
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            // Navigate back to the search page
            window.location.href = '/search';
        });
    }

});